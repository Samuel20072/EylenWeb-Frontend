<!-- ========================================= -->
<!-- =============== FONDO =================== -->
<!-- ========================================= -->
<div
  class="fixed inset-0 bg-black/40 backdrop-blur-sm flex justify-center items-center z-40 p-4"
  (click)="closeModal()"
  #overlay
  *ngIf="isOpen"
>

  <!-- ========================================= -->
  <!-- =============== MODAL ==================== -->
  <!-- ========================================= -->
  <div
    class="bg-white rounded-3xl shadow-2xl w-full max-w-sm mx-auto relative max-h-[92vh] overflow-y-auto p-6
           animate-[fadeIn_.25s_ease-out]"
    (click)="$event.stopPropagation()"
    #modal
  >

    <!-- Botón Cerrar -->
    <button
      (click)="closeModal()"
      class="absolute top-4 right-4 text-gray-400 hover:text-rose-600 transition text-xl p-1"
      [disabled]="isLoading"
    >
      ✕
    </button>

    <!-- ========================================= -->
    <!-- =============== HEADER =================== -->
    <!-- ========================================= -->
    <div class="mb-6 text-center">
      <div class="flex items-center justify-center mb-3">
        <div class="bg-rose-100 p-3 rounded-full shadow-inner">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7 text-rose-700" fill="none" viewBox="0 0 24 24"
            stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round"
              d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z" />
          </svg>
        </div>
      </div>

      <h2 class="text-2xl font-bold text-rose-700">Comprobante de Pago</h2>
      <p class="text-gray-500 text-xs mt-1 px-3">
        Adjunta la evidencia del pago para completar tu compra.
      </p>
    </div>


    <!-- ========================================= -->
    <!-- =============== FORM ===================== -->
    <!-- ========================================= -->
    <form class="flex flex-col gap-5" (submit)="onSubmit($event)">

      <!-- Paquete -->
      <div class="bg-rose-50 border border-rose-200 rounded-xl p-3 shadow-inner">
        <label class="text-xs font-semibold text-rose-700 block mb-1">Paquete Seleccionado</label>
        <p class="font-semibold text-gray-900 text-sm leading-tight">
          {{ selectedPackage?.title || selectedPackage?.name || 'Sin paquete seleccionado' }}
        </p>
      </div>

      <!-- Método de pago -->
      <div class="flex flex-col gap-1">
        <label class="text-xs font-semibold text-gray-700">Método de Pago</label>
        <select
          class="rounded-xl p-2 text-sm border border-gray-300 focus:outline-none focus:ring-2 focus:ring-rose-400 transition"
          [(ngModel)]="formData.paymentMethod"
          name="paymentMethod"
          required
          [disabled]="isLoading"
        >
          <option value="" disabled selected>Selecciona método de pago</option>
          <option value="Nequi">Nequi</option>
          <option value="Daviplata">Daviplata</option>
          <option value="Bancolombia">Bancolombia</option>
        </select>
      </div>

      <!-- Monto -->
      <div class="bg-gray-100 border border-gray-300 rounded-xl p-3">
        <label class="text-xs font-medium text-gray-500 block mb-1">Monto a Pagar</label>
        <input
          type="text"
          readonly
          class="w-full bg-transparent text-gray-900 font-bold font-mono text-base p-0 border-none focus:ring-0"
          [value]="formData.amount"
          [disabled]="isLoading"
        />
      </div>

      <!-- Archivo -->
      <div class="flex flex-col gap-1">
        <label class="text-xs font-semibold text-gray-700">Sube tu comprobante</label>
        <input
          type="file"
          (change)="onFileSelected($event)"
          accept="image/*"
          class="w-full text-sm text-gray-600 file:mr-4 file:py-1.5 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-rose-100 file:text-rose-700 hover:file:bg-rose-200 cursor-pointer transition"
          required
          [disabled]="isLoading"
        />
      </div>

      <!-- Comentario -->
      <textarea
        placeholder="Comentario opcional (notas para el administrador)"
        rows="3"
        class="border border-gray-300 rounded-xl p-3 text-sm focus:outline-none focus:ring-2 focus:ring-rose-400 transition"
        [(ngModel)]="formData.message"
        name="message"
        [disabled]="isLoading"
      ></textarea>

      <!-- Estado -->
      <div
        *ngIf="message"
        class="p-3 rounded-lg text-sm font-medium transition"
        [ngClass]="{
          'bg-green-100 text-green-700': message.includes('✅'),
          'bg-red-100 text-red-700': message.includes('Error') || message.includes('Por favor')
        }"
      >
        {{ message }}
      </div>

      <!-- Botón -->
      <button
        type="submit"
        class="bg-rose-600 text-white py-3 rounded-xl text-sm font-semibold shadow-lg shadow-rose-200 hover:bg-rose-700 transition-all flex items-center justify-center disabled:bg-gray-400 disabled:cursor-not-allowed"
        [disabled]="!selectedFile || isLoading"
      >
        <span *ngIf="!isLoading">Enviar comprobante y finalizar compra</span>

        <span *ngIf="isLoading" class="flex items-center gap-2">
          <svg class="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none"
            viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10"
              stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor"
              d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 
              3.042 1.135 5.824 3 7.938l3-2.647z"></path>
          </svg>
          Procesando...
        </span>
      </button>
    </form>
  </div>
</div>


<!-- ========================================= -->
<!-- Modal de Confirmación -->
<!-- ========================================= -->
<app-confirmation-modal
  [isOpen]="isConfirmationOpen"
  [title]="'Confirmación de Compra'"
  [message]="'Estás a punto de confirmar la compra del paquete ' + selectedPackage?.title + ' por un valor de ' + formData.amount + '. Una vez enviado el comprobante, tu compra será revisada. ¿Deseas continuar?'"
  [confirmText]="'Sí, Confirmar Compra'"
  [cancelText]="'Revisar de Nuevo'"
  (confirmed)="confirmSubmission()"
  (canceled)="cancelSubmission()"
  (close)="closeConfirmation()"
></app-confirmation-modal>

