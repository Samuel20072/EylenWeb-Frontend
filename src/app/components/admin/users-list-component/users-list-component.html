<!-- CONTENEDOR PRINCIPAL -->
<div
  #list
  class="bg-white rounded-2xl p-6 shadow-xl w-full h-full min-h-[500px] flex flex-col border border-red-200"
>
  <!-- T칤tulo -->
  <h3 class="text-3xl font-bold text-red-800 mb-6 pb-3 border-b border-red-200">
    Gesti칩n de Compras y Usuarios
  </h3>

  <!-- 游댌 Buscador -->
  <div class="relative mb-5">
    <input
      #searchInput
      type="text"
      placeholder="Buscar por nombre, correo o paquete..."
      (input)="filterUsers($event)"
      class="w-full p-3 pl-12 rounded-xl border border-red-300 focus:ring-2 focus:ring-red-500 outline-none shadow-sm transition"
    />
    <i class="fa-solid fa-magnifying-glass absolute left-4 top-3.5 text-red-400 text-lg"></i>
  </div>

  <!-- Error -->
  <div
    *ngIf="errorMessage"
    class="bg-red-100 border border-red-300 text-red-700 px-4 py-3 rounded-lg mb-4 text-sm shadow-sm"
  >
    {{ errorMessage }}
  </div>

  <!-- LISTA DE USUARIOS -->
  <div class="space-y-5 flex-1 overflow-y-auto pr-2" style="max-height: 70vh;">
    
    <!-- Loader -->
    <div *ngIf="isLoading" class="flex justify-center items-center h-48">
      <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-red-500"></div>
      <p class="ml-3 text-red-700 font-medium">Cargando compras...</p>
    </div>

    <!-- Sin resultados -->
    <div *ngIf="!isLoading && filteredUsers.length === 0" class="text-center py-12 text-red-400">
      <i class="fas fa-clipboard-check text-4xl mb-3 opacity-60"></i>
      <p class="font-semibold text-red-700">No hay compras pendientes o coincidencias.</p>
    </div>

    <!-- Item de usuario -->
    <div
      *ngFor="let u of filteredUsers; trackBy: trackByPurchaseId"
      #userRow
      (click)="goToUserDetail(u)"
      class="user-row flex flex-col gap-4 p-5 rounded-xl cursor-pointer transition-all duration-300 shadow-sm border-l-4 hover:shadow-md"
      [ngClass]="{
        'bg-red-50 border-red-500 hover:bg-red-100': u.status === 'PENDING',
        'bg-green-50 border-green-600 hover:bg-green-100': u.status === 'APPROVED',
        'bg-red-100 border-red-600 hover:bg-red-200': u.status === 'REJECTED'
      }"
    >
      <!-- ENCABEZADO -->
      <div class="flex items-center gap-4">
        <div class="w-12 h-12 rounded-full bg-red-600 flex items-center justify-center shadow-lg text-white text-lg font-bold">
          {{ u.name[0] | uppercase }}
        </div>

        <div class="flex-1 min-w-0">
          <div class="font-semibold text-lg text-red-800 truncate">
            {{ u.name }}
            <span class="text-sm text-red-500 font-normal">({{ u.email }})</span>
          </div>
          <p class="text-sm text-red-700 font-medium">
            Paquete: {{ u.package }}
          </p>
        </div>
      </div>

      <!-- INFORMACI칍N DE PAGO Y ACCIONES -->
      <div class="flex flex-col md:flex-row items-start md:items-center justify-between bg-white p-4 rounded-xl border border-red-200 shadow-inner">

        <!-- Informaci칩n del Pago -->
        <div class="mb-3 md:mb-0">
          <p class="text-base font-bold text-red-800">
            游눯 Monto: ${{ u.payment.amount | number: '1.0-0' }}
          </p>
          <p class="text-xs text-red-500">
            游늰 Compra: {{ u.payment.date }}
          </p>
        </div>

        <!-- BOTONES -->
        <div class="flex flex-wrap gap-3 items-center">

          <!-- Ver comprobante -->
          <button
            (click)="viewProof(u); $event.stopPropagation()"
            class="px-3 py-1.5 text-sm font-medium text-white bg-red-600 rounded-lg hover:bg-red-700 transition shadow-sm flex items-center"
          >
            <i class="fas fa-file-invoice mr-2"></i> Ver Comprobante
          </button>

          <!-- Acciones si est치 pendiente -->
          <div *ngIf="u.status === 'PENDING'" class="flex gap-2">

            <button
              (click)="validatePayment(u); $event.stopPropagation()"
              class="bg-green-600 hover:bg-green-700 text-white text-sm px-4 py-1.5 rounded-lg shadow-sm transition font-semibold flex items-center"
            >
              <i class="fas fa-check-circle mr-2"></i> Validar
            </button>

            <button
              (click)="rejectPayment(u); $event.stopPropagation()"
              class="bg-red-700 hover:bg-red-800 text-white text-sm px-4 py-1.5 rounded-lg shadow-sm transition font-semibold flex items-center"
            >
              <i class="fas fa-times-circle mr-2"></i> Rechazar
            </button>

          </div>

          <!-- Estado final -->
          <span
            *ngIf="u.status !== 'PENDING'"
            class="text-xs font-bold px-3 py-1.5 rounded-full"
            [ngClass]="
              u.status === 'APPROVED'
                ? 'bg-green-100 text-green-700'
                : 'bg-red-200 text-red-800'
            "
          >
            {{ u.status === 'APPROVED' ? 'APROBADO' : 'RECHAZADO' }}
          </span>

        </div>
      </div>

      <!-- INFORMACI칍N DE CLASES -->
      <div class="text-sm text-red-800 pt-3 border-t border-red-200">
        <p class="font-semibold">
          Pr칩xima Clase:
          <span class="font-normal text-red-600">{{ u.nextClass }}</span>
          <span class="ml-4 text-red-500">
            | Restantes: {{ u.remaining }} sesiones
          </span>
        </p>
      </div>
    </div>
  </div>
</div>

<!-- ---------------------------------------------------------------------- -->
<!-- MODAL COMPROBANTE -->
<!-- ---------------------------------------------------------------------- -->
<div
  *ngIf="showProofModal"
  class="fixed inset-0 bg-black bg-opacity-70 z-50 flex items-center justify-center p-4 backdrop-blur-sm transition"
>
  <div class="bg-white rounded-2xl shadow-2xl w-full max-w-3xl overflow-hidden transform transition-all scale-100">

    <!-- Encabezado -->
    <div class="flex justify-between items-center p-4 border-b bg-red-50">
      <h2 class="text-lg md:text-xl font-bold text-red-800 truncate">
        {{ currentProofName }}
      </h2>

      <button
        (click)="closeProofModal()"
        class="text-red-600 hover:text-red-800 transition p-2 rounded-full hover:bg-red-100"
      >
        <i class="fas fa-times text-xl"></i>
      </button>
    </div>

    <!-- Contenido -->
    <div class="p-4 max-h-[80vh] overflow-y-auto">
      <iframe
        [src]="currentProofUrl"
        title="Comprobante de Pago"
        class="w-full h-[65vh] border-2 border-red-200 rounded-xl shadow-inner"
        frameborder="0"
        sandbox="allow-scripts allow-same-origin allow-popups allow-forms"
      ></iframe>

      <p class="mt-4 text-xs text-red-500 text-center">
        Enlace directo:
        <a
          [href]="currentProofUrl"
          target="_blank"
          class="text-red-600 hover:underline font-medium break-all"
        >
          Abrir en una nueva pesta침a
        </a>
      </p>
    </div>
  </div>
</div>
